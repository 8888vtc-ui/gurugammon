generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model analyses {
  id            String       @id
  user_id       String
  board_state   String
  dice          Int[]
  move          String
  best_move     String
  equity        Float
  pr            Float
  explanation   String
  alternatives  Json         @default("[]")
  analysis_type AnalysisType @default(FULL)
  createdAt     DateTime     @default(now())
  users         users        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, createdAt])
}

model chat_messages {
  id           String      @id
  game_id      String
  user_id      String?
  message      String
  message_type MessageType @default(TEXT)
  createdAt    DateTime    @default(now())
  games        games       @relation(fields: [game_id], references: [id], onDelete: Cascade)
  users        users?      @relation(fields: [user_id], references: [id])
}

model game_moves {
  id            String   @id
  game_id       String
  user_id       String?
  player        Player
  dice          Int[]
  move          String
  from_point    Int?
  to_point      Int?
  equity        Float?
  pr            Float?
  thinking_time Int?
  createdAt     DateTime @default(now())
  games         games    @relation(fields: [game_id], references: [id], onDelete: Cascade)
  users         users?   @relation(fields: [user_id], references: [id])

  @@index([game_id, createdAt])
}

model games {
  id                                 String                  @id
  white_player_id                    String?
  black_player_id                    String?
  status                             GameStatus              @default(WAITING)
  board_state                        String                  @default("4HPwATDgc/ABMA")
  gameMode                           GameMode                @default(AI_VS_PLAYER)
  current_player                     Player                  @default(WHITE)
  dice                               Int[]                   @default([])
  white_score                        Int                     @default(0)
  black_score                        Int                     @default(0)
  createdAt                          DateTime                @default(now())
  finished_at                        DateTime?
  winner                             Player?
  tournament_id                      String?
  chat_messages                      chat_messages[]
  game_moves                         game_moves[]
  users_games_black_player_idTousers users?                  @relation("games_black_player_idTousers", fields: [black_player_id], references: [id])
  tournaments                        tournaments?            @relation(fields: [tournament_id], references: [id])
  users_games_white_player_idTousers users?                  @relation("games_white_player_idTousers", fields: [white_player_id], references: [id])
  websocket_connections              websocket_connections[]

  @@index([black_player_id])
  @@index([status, createdAt])
  @@index([white_player_id])
}

model subscriptions {
  id                     String             @id
  user_id                String             @unique
  stripe_subscription_id String?            @unique
  stripe_customer_id     String?
  plan                   SubscriptionPlan
  status                 SubscriptionStatus
  current_period_start   DateTime?
  current_period_end     DateTime?
  cancel_at_period_end   Boolean            @default(false)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime
  users                  users              @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model tournament_participants {
  id               String      @id
  tournament_id    String
  user_id          String
  registered_at    DateTime    @default(now())
  current_position Int?
  eliminated_at    DateTime?
  tournaments      tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade)
  users            users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([tournament_id, user_id])
}

model tournaments {
  id                      String                    @id
  name                    String
  description             String?
  entryFee                Int                       @default(0)
  prizePool               Int                       @default(0)
  maxPlayers              Int?
  status                  TournamentStatus          @default(REGISTRATION)
  start_time              DateTime?
  end_time                DateTime?
  created_by              String
  createdAt               DateTime                  @default(now())
  games                   games[]
  tournament_participants tournament_participants[]
  users                   users                     @relation(fields: [created_by], references: [id])
}

model user_analytics {
  id                           String   @id
  user_id                      String
  date                         DateTime @default(now())
  games_played                 Int      @default(0)
  games_won                    Int      @default(0)
  analyses_completed           Int      @default(0)
  time_played                  Int      @default(0)
  avg_equity                   Float    @default(0)
  elo_change                   Int      @default(0)
  claude_requests_today        Int      @default(0)
  claude_requests_this_month   Int      @default(0)
  claude_quota_remaining       Int      @default(10)
  createdAt                    DateTime @default(now())
  users                        users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, date])
}

model users {
  id                                 String                    @id
  email                              String                    @unique
  password                           String
  username                           String                    @unique
  avatar                             String?
  level                              Level                     @default(BEGINNER)
  elo                                Int                       @default(1500)
  subscriptionType                   SubscriptionType          @default(FREE)
  isActive                           Boolean                   @default(true)
  emailVerified                      Boolean                   @default(false)
  createdAt                          DateTime                  @default(now())
  lastLoginAt                        DateTime                  @default(now())
  analyses                           analyses[]
  chat_messages                      chat_messages[]
  game_moves                         game_moves[]
  games_games_black_player_idTousers games[]                   @relation("games_black_player_idTousers")
  games_games_white_player_idTousers games[]                   @relation("games_white_player_idTousers")
  subscriptions                      subscriptions?
  tournament_participants            tournament_participants[]
  tournaments                        tournaments[]
  user_analytics                     user_analytics[]
  websocket_connections              websocket_connections[]
}

model websocket_connections {
  id            String   @id
  connection_id String   @unique
  user_id       String
  game_id       String?
  connected_at  DateTime @default(now())
  last_ping     DateTime @default(now())
  is_active     Boolean  @default(true)
  games         games?   @relation(fields: [game_id], references: [id])
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([game_id])
  @@index([user_id])
}

enum AnalysisType {
  FULL
  HINT
  EVALUATE
}

enum GameMode {
  AI_VS_PLAYER
  PLAYER_VS_PLAYER
  TOURNAMENT
}

enum GameStatus {
  WAITING
  PLAYING
  FINISHED
  ABORTED
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  MASTER
}

enum MessageType {
  TEXT
  EMOJI
  SYSTEM
}

enum Player {
  WHITE
  BLACK
}

enum SubscriptionPlan {
  FREE
  PREMIUM
  VIP
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

enum SubscriptionType {
  FREE
  PREMIUM
  VIP
}

enum TournamentStatus {
  REGISTRATION
  IN_PROGRESS
  FINISHED
  CANCELLED
}
